"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function e(e,t){for(var s=0;s<t.length;s++){var i=t[s];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,s,i){return s&&e(t.prototype,s),i&&e(t,i),t}}(),_dec,_class,_wepy=require("./../npm/wepy/lib/wepy.js"),_wepy2=_interopRequireDefault(_wepy),_wepyRedux=require("./../npm/wepy-redux/lib/index.js"),_actions=require("./../store/actions/index.js"),_common=require("./../utils/common.js"),_createClass2=require("./../api/createClass.js"),store=(0,_wepyRedux.getStore)(),joinClass=(_dec=(0,_wepyRedux.connect)({cityList:function(e){return e.zone.city_list},cityName:function(e){return e.zone.city_name},longitude:function(e){return e.zone.lng},latitude:function(e){return e.zone.lat}}))(_class=function(e){function t(){var e,s,i,o;_classCallCheck(this,t);for(var a=arguments.length,n=Array(a),r=0;r<a;r++)n[r]=arguments[r];return s=i=_possibleConstructorReturn(this,(e=t.__proto__||Object.getPrototypeOf(t)).call.apply(e,[this].concat(n))),i.config={navigationBarTitleText:"创建班级"},i.data={classNumber:0,gradeNumber:0,activeClassType:0,showSchool:!1,classTypes:[{title:"幼儿园",id:0,value:"kindergarten"},{title:"小学",id:1,value:"primary"},{title:"初中",id:2,value:"middle"},{title:"高中",id:3,value:"high"}],memberInfo:null,schoolList:[],type:"",keywords:"",schoolId:0,cityIndex:-1},i.methods={setPage:function(e,t){"createClass"===e?(this.type=t,wx.setNavigationBarTitle({title:"join"===this.type?"加入班级":"创建班级"}),this.$apply()):wx.switchTab({url:"classList"})},deleteSchool:function(){this.keywords="",this.schoolId=0,this.showSchool=!1,this.$apply()},setSchool:function(e){this.schoolId=e.id,this.keywords=e.name,this.showSchool=!1,this.$apply()},createSchool:function(){var e=this;(0,_createClass2.createSchool)({name:this.keywords,city_name:this.cityName}).then(function(t){var s=t.data;s.success&&((0,_common.showMsg)("学校创建成功"),e.schoolId=s.data.school_id,e.showSchool=!1,e.$apply())})},hideSchool:function(){this.showSchool=!1,this.$apply()},bindInput:function(e){var t=e.currentTarget.id;this[t]=e.detail.value,"keywords"!==t||(0,_common.isEmptyString)(this.keywords)?this.showSchool=!1:(0,_common.throttle)(this.getSchoolList,this,1e3),this.$apply()},select:function(e){this.activeClassType=e,this.$apply()},bindPicker:function(e){var t=e.currentTarget.id,s=e.detail.value;this[t]=s,"cityIndex"===t&&(0,_actions.setCityName)(this.cityList[s].city_name)},submit:function(){if(!this.gradeNumber)return void(0,_common.showMsg)("请输入级别号");if(!this.classNumber)return void(0,_common.showMsg)("请输入班级号");if(!this.schoolId)return void(0,_common.showMsg)("请输入学校名称");var e={school_id:this.schoolId,grade:this.classTypes[this.activeClassType].value,year:Number(this.gradeNumber),class:Number(this.classNumber)};"create"===this.type&&this.createClassCallback(e),"join"===this.type&&this.checkClassExist(e)}},o=s,_possibleConstructorReturn(i,o)}return _inherits(t,e),_createClass(t,[{key:"checkClassExist",value:function(e){(0,_createClass2.searchClass)(e).then(function(e){var t=e.data.data;t&&t.id?_wepy2.default.navigateTo({url:"joinClass?classId="+t.id+"&name="+t.name}):(0,_common.showMsg)("您输入的班级不存在，请重试")})}},{key:"createClassCallback",value:function(e){this.$parent.globalData.createClass=e,_wepy2.default.navigateTo({url:"bindRelationship?type=create"})}},{key:"onLoad",value:function(e){!this.cityList.length&&(0,_actions.setCityList)(),!this.longitude&&this.wxGetLocation(),this.type=e.type,wx.setNavigationBarTitle({title:"join"===this.type?"加入班级":"创建班级"});var t=this.$parent.globalData;this.memberInfo=t.memberInfo,this.$apply()}},{key:"wxGetLocation",value:function(){wx.getLocation({type:"wgs84",complete:function(e){var t=e.latitude,s=e.longitude;(0,_actions.saveLocation)({lat:t,lng:s}),(0,_actions.getCityName)({lat:t,lng:s})}})}},{key:"getSchoolList",value:function(){var e=this;this.keywords.length&&(0,_createClass2.schoolList)({keywords:this.keywords,city_name:this.cityName}).then(function(t){e.schoolList=t.data.list,e.showSchool=!0,e.$apply()})}}]),t}(_wepy2.default.page))||_class;Page(require("./../npm/wepy/lib/wepy.js").default.$createPage(joinClass,"pages/createClass"));