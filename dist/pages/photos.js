"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,o=Array(e.length);t<e.length;t++)o[t]=e[t];return o}return Array.from(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function e(e,t){for(var o=0;o<t.length;o++){var i=t[o];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,o,i){return o&&e(t.prototype,o),i&&e(t,i),t}}(),_dec,_class,_wepy=require("./../npm/wepy/lib/wepy.js"),_wepy2=_interopRequireDefault(_wepy),_wepyRedux=require("./../npm/wepy-redux/lib/index.js"),_common=require("./../utils/common.js"),_zone=require("./../api/zone.js"),store=(0,_wepyRedux.getStore)(),bindRelationship=(_dec=(0,_wepyRedux.connect)({isPresident:function(e){return e.zone.isPresident}}))(_class=function(e){function t(){var e,o,i,s;_classCallCheck(this,t);for(var n=arguments.length,r=Array(n),a=0;a<n;a++)r[a]=arguments[a];return o=i=_possibleConstructorReturn(this,(e=t.__proto__||Object.getPrototypeOf(t)).call.apply(e,[this].concat(r))),i.config={navigationBarTitleText:"相册"},i.data={msg:"",list:[],memberInfo:null,classInfo:null,ps:6,pn:1,maxCount:6,imgList:[],uploads:[],isEditMode:!1,deleteIds:[],loading:!1,loadFinished:!1},i.methods={editPhoto:function(e,t,o,i){if(this.memberInfo.member_id!==i&&!this.isPresident)return void(0,_common.showMsg)("您没有权限删除该照片");var s="edit"===o?"delete":"edit",n=this.list[e].img_list[t].photo_img_id;if(this.list[e].img_list[t].type=s,"delete"===s)this.deleteIds.push(n);else{var r=this.deleteIds.indexOf(n);this.deleteIds.splice(r,1)}this.$apply()},chooseAll:function(){this.loopPhoto("delete"),this.$apply()},reset:function(){this.resetPhoto()},deletePhoto:function(){var e=this;this.deleteIds.length&&((0,_zone.delPhoto)({photo_img_ids:this.deleteIds,class_id:this.classInfo.id}).then(function(t){t.data.success&&((0,_common.showMsg)("删除成功"),e.resetPhoto(),e.resetData(),e.getPhotoList())}),this.$apply())},setPhotoEdit:function(){this.isEditMode=!0,this.loopPhoto("edit"),this.$apply()},preview:function(e,t){wx.previewImage({current:e.img_url,urls:t})},upload:function(){var e=this,t=this;wx.chooseImage({count:9,sizeType:["original","compressed"],sourceType:["album","camera"],success:function(o){var i=o.tempFilePaths.length;i>e.maxPhotoCount&&wx.showToast({title:"最多只能选择"+e.maxPhotoCount+"张图片",icon:"none"}),wx.showLoading({title:"图片上传中"}),o.tempFilePaths.forEach(function(o){var s={};s.path=o,s.error=!1,s.uploadProgress=wx.uploadFile({url:_wepy2.default.$appConfig.baseUrl+"/file/uploadPic",filePath:o,formData:{member_id:e.memberInfo.member_id,member_token:e.memberInfo.member_token,folder:"committee"},name:"file",success:function(e){var o=JSON.parse(e.data);if(o.data&&o.data.file_url){var s=o.data.file_url;t.imgList.push(s)}t.imgList.length===i&&(setTimeout(function(){wx.hideLoading()},2e3),t.addPhotos()),t.$apply()}}),s.uploadProgress.onProgressUpdate(function(e){s.progress=e.progress}),t.uploads.push(s),t.$apply()})}})}},s=o,_possibleConstructorReturn(i,s)}return _inherits(t,e),_createClass(t,[{key:"onReachBottom",value:function(){this.loading||this.loadFinished||this.getPhotoList()}},{key:"onLoad",value:function(){console.log(store.getState()),this.classInfo=wx.getStorageSync("classInfo"),this.memberInfo=wx.getStorageSync("memberInfo"),this.getPhotoList(),this.$apply()}},{key:"getPhotoList",value:function(){var e=this;this.loading=!0,(0,_zone.photoIndex)({ps:this.ps,pn:this.pn,class_id:this.classInfo.id}).then(function(t){for(var o=[].concat(_toConsumableArray(t.data.list)),i=0,s=o.length;i<s;i++){o[i]={img_list:o[i].img_list,upload_date:o[i].upload_date,upload_members:o[i].upload_members,preview_list:[]};for(var n=0,r=o[i].img_list.length;n<r;n++){var a=o[i].img_list[n];a.type=e.isEditMode?"edit":"none",o[i].preview_list.push(a.img_url)}}e.list=[].concat(_toConsumableArray(e.list),_toConsumableArray(o)),t.data.list.length<e.ps&&(e.loadFinished=!0),e.loading=!1,e.pn++,e.$apply()})}},{key:"addPhotos",value:function(){var e=this;(0,_zone.addPhoto)({class_id:this.classInfo.id,img_url:this.imgList}).then(function(t){t.data.success&&((0,_common.showMsg)("提交成功"),e.resetData(),e.getPhotoList(),e.imgList=[],e.$apply())})}},{key:"loopPhoto",value:function(e){for(var t=0,o=this.list.length;t<o;t++)for(var i=this.list[t].img_list,s=0,n=i.length;s<n;s++)"edit"!==e||i[s].member_id===this.memberInfo.member_id||this.isPresident?i[s].type=e:(console.log(1),i[s].type="none")}},{key:"resetPhoto",value:function(){this.deleteIds=[],this.isEditMode=!1,this.loopPhoto("none"),this.$apply()}},{key:"resetData",value:function(){this.ps=6,this.pn=1,this.loading=!1,this.loadFinished=!1,this.list=[],this.$apply()}}]),t}(_wepy2.default.page))||_class;Page(require("./../npm/wepy/lib/wepy.js").default.$createPage(bindRelationship,"pages/photos"));