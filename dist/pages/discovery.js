"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),_wepy=require("./../npm/wepy/lib/wepy.js"),_wepy2=_interopRequireDefault(_wepy),_common=require("./../utils/common.js"),_selectModal=require("./../components/selectModal.js"),_selectModal2=_interopRequireDefault(_selectModal),_commentModal=require("./../components/commentModal.js"),_commentModal2=_interopRequireDefault(_commentModal),_shareModal=require("./../components/shareModal.js"),_shareModal2=_interopRequireDefault(_shareModal),_zone=require("./../api/zone.js"),Discovery=function(e){function t(){var e,n,o,s;_classCallCheck(this,t);for(var i=arguments.length,a=Array(i),r=0;r<i;r++)a[r]=arguments[r];return n=o=_possibleConstructorReturn(this,(e=t.__proto__||Object.getPrototypeOf(t)).call.apply(e,[this].concat(a))),o.config={navigationBarTitleText:"家长圈子",enablePullDownRefresh:!0},o.$repeat={},o.$props={CurrentModal:{sureBtnText:"确认",cancelBtnText:"取消",placeholderText:"请输入评论内容","xmlns:v-bind":"","v-bind:flag.sync":"commentFlag","v-bind:commentInput.sync":"commentInput","xmlns:v-on":""},SelectModal:{"v-bind:flag.sync":"selectFlag","v-bind:list.sync":"payMemberList"},shareModal:{"v-bind:flag.sync":"showShareFlag","v-bind:title.sync":"shareTitle","v-bind:imgSrc.sync":"shareImg"}},o.$events={CurrentModal:{"v-on:cancel":"commentCancel","v-on:sure":"commentSure","v-on:input":"bindCommentInput"},SelectModal:{"v-on:cancel":"selectCancel","v-on:sure":"selectSure"},shareModal:{"v-on:cancel":"cancelShareFn","v-on:sure":"cancelShareFn"}},o.components={CurrentModal:_commentModal2.default,SelectModal:_selectModal2.default,shareModal:_shareModal2.default},o.data={commentFlag:!1,pn:1,ps:10,list:[],classInfo:null,memberInfo:null,schoolInfo:null,loading:!1,loadFinished:!1,commentInput:"",currentReplyId:-1,currentReplyRootId:-1,currentReplyToCommentId:-1,commentPn:2,commentPs:6,commentOffset:6,commentLoadFinished:!1,memberList:[],loadMoreCommentArray:[],shareTitle:"",showShareFlag:!1,shareImg:"../images/share/circles.jpg"},o.watch={classInfo:function(e,t){null!==t&&(this.resetData(),this.getZoneList())}},o.methods={addLike:function(e,t,n){var o=this;if(!this.classInfo&&!this.classInfo.id)return void(0,_common.showMsg)("请先加入班级");(0,_zone.addLike)({class_id:this.classInfo.id,moment_id:e}).then(function(s){if(s.data.success){n?((0,_common.showMsg)("取消点赞成功"),o.list[t].like_list.count--):((0,_common.showMsg)("点赞成功"),o.list[t].like_list.count++),o.list[t].is_like=!n;var i={moment_id:e,member_id:o.memberInfo.member_id,member:o.memberInfo};o.list[t].like_list.list=(0,_common.filterArrayByValue)(o.memberInfo.member_id,o.list[t].like_list.list,n,i),o.$apply()}})},cancelShareFn:function(){this.showShareFlag=!1,this.$apply()},shareCircle:function(){this.shareTitle=this.memberInfo.nickname+"分享了一个发现，点击浏览",this.showShareFlag=!0,this.$apply()},removeCircle:function(e,t){var n=this;(0,_zone.deleteCircle)({moment_id:e,class_id:this.classInfo.id}).then(function(e){e.data.success&&((0,_common.showMsg)("成功删除"),n.list.splice(t,1),n.$apply())})},loadMoreComment:function(e,t){var n=this,o=this.findLoadmoreCommentInfo(this.loadMoreCommentArray,e);(0,_zone.getCommentList)({moment_id:e,ps:this.commentPs,pn:o.commentPn?o.commentPn:this.commentPn,offset:this.commentOffset}).then(function(s){if(s.data.success){var i=s.data.list,a=n.list[t].comment_list.list;if(a=[].concat(_toConsumableArray(a),_toConsumableArray(i)),n.list[t].comment_list.list=a,i.length<n.commentPs&&(n.list[t].commentLoadFinished=!0),o.commentPn)n.loadMoreCommentArray[o.index].commentPn=o.commentPn+1;else{var r={commentPn:n.commentPn+1,moment_id:e};n.loadMoreCommentArray.push(r)}n.$apply()}})},addComment:function(e,t,n,o,s){return o===this.memberInfo.member_id?void(0,_common.showMsg)("请不要回复自己"):this.classInfo?(this.commentFlag=!0,this.currentReplyId=t,this.currentReplyRootId="add"===e?0:n,this.commentInput=void 0!==s?"@"+s+":":"",void this.$apply()):void(0,_common.showMsg)("请先加入班级")},bindCommentInput:function(e){this.commentInput=e,this.$apply()},commentSure:function(){var e=this;this.commentFlag=!1,(0,_zone.addComment)({class_id:this.classInfo.id,moment_id:this.currentReplyId,content:this.currentReplyId>0?this.commentInput.replace(/^@.+:/,""):this.commentInput,root_id:this.currentReplyRootId,to_comment_id:this.currentReplyRootId}).then(function(t){t.data.success&&(e.commentInput="",e.resetData(),e.getZoneList(),e.$apply())})},commentCancel:function(){this.commentFlag=!1,this.commentInput="",this.$apply()},preview:function(e,t){(0,_common.previewImage)(e,t)}},s=n,_possibleConstructorReturn(o,s)}return _inherits(t,e),_createClass(t,[{key:"resetData",value:function(){this.loadMoreCommentArray=[],this.commentLoadFinished=!1,this.commentPn=2,this.commentPs=6,this.pn=1,this.list=[],this.$apply()}},{key:"onPullDownRefresh",value:function(){this.resetData(),this.getZoneList()}},{key:"onReachBottom",value:function(){this.loading||this.loadFinished||this.getZoneList()}},{key:"onLoad",value:function(){this.classInfo=wx.getStorageSync("classInfo"),this.memberInfo=wx.getStorageSync("memberInfo"),this.$parent.globalData.userData=this.memberInfo,this.$apply(),this.memberInfo&&-1===this.memberInfo.member_id||this.getZoneList()}},{key:"onShow",value:function(){this.classInfo=wx.getStorageSync("classInfo")}},{key:"getZoneList",value:function(){var e=this;this.loading=!0,this.$apply();this.classInfo.id;(0,_zone.getCircleList)({see_type:"all",type:"circles",pn:this.pn,ps:this.ps,comment_count:3}).then(function(t){var n=t.data.list;e.loading=!1,e.pn++,n.length<e.ps&&(e.loadFinished=!0),e.list=[].concat(_toConsumableArray(e.list),_toConsumableArray(n)),e.$apply()})}},{key:"findLoadmoreCommentInfo",value:function(e,t){for(var n={},o=0,s=e.length;o<s;o++)e[o].moment_id===t&&(n=Object.assign({},e[o],{index:o}));return n}},{key:"onShareAppMessage",value:function(e){return{title:this.shareTitle,imageUrl:this.shareImg}}}]),t}(_wepy2.default.page);Page(require("./../npm/wepy/lib/wepy.js").default.$createPage(Discovery,"pages/discovery"));