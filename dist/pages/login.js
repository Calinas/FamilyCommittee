"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),_wepy=require("./../npm/wepy/lib/wepy.js"),_wepy2=_interopRequireDefault(_wepy),_common=require("./../utils/common.js"),_login=require("./../api/login.js"),login=function(e){function t(){var e,n,i,o,a;_classCallCheck(this,t);for(var r=arguments.length,s=Array(r),c=0;c<r;c++)s[c]=arguments[c];return i=o=_possibleConstructorReturn(this,(e=t.__proto__||Object.getPrototypeOf(t)).call.apply(e,[this].concat(s))),o.config={navigationBarTitleText:"登录"},o.data=(n={unionid:"",wxtoken:"",openid:"",show_lay:!1,nickname:"用户",sex:"",head_img:"",phone:"",open_id:"",joinKey:"",classId:-1,name:""},_defineProperty(n,"show_lay",!1),_defineProperty(n,"forWeixinTest",!1),_defineProperty(n,"testPhone",""),_defineProperty(n,"testCode",""),n),o.methods={bindTest:function(e){this[e.currentTarget.id]=Number(e.detail.value),this.$apply()},loginTest:function(){if(13456780980!==this.testPhone||123456!==this.testCode)return void(0,_common.showMsg)("请填写正确的账户信息");var e=Object.create(null);e={member_id:2,member_token:"9FCE2410F6980C5EA6A6C8B233BD9E22"},wx.setStorageSync("memberInfo",e),wx.switchTab({url:"classList"})},getUserInfo:function(e){var t=this,n=e.detail;if(!n.rawData)return(0,_common.showMsg)("授权失败"),this.forWeixinTest=!0,this.show_lay=!1,void this.$apply();(0,_login.decryptData)({encryptedData:n.encryptedData,iv:n.iv,wxapp_token:this.wxtoken}).then(function(e){var n=e.data.decryptedData;t.unionid=n.unionId,t.nickname=n.nickName,t.sex=n.gender,t.head_img=n.avatarUrl,t.show_lay=!0,t.open_id=n.openId,t.$apply()})},getPhoneNumber:function(e){var t=this,n=e.detail;if(!n.encryptedData)return(0,_common.showMsg)("授权失败"),this.forWeixinTest=!0,this.show_lay=!1,void this.$apply();(0,_login.decryptData)({encryptedData:n.encryptedData,iv:n.iv,wxapp_token:this.wxtoken}).then(function(e){t.phone=e.data.decryptedData.phoneNumber,t.$apply(),t.loginByWeixin()})}},a=i,_possibleConstructorReturn(o,a)}return _inherits(t,e),_createClass(t,[{key:"loginByWeixin",value:function(){var e=this;(0,_login.wxLogin)({open_id:this.open_id,nickname:this.nickname,head_img:this.head_img,sex:this.sex,auth_id:this.unionid,wxapp_token:this.wxtoken,mobile:this.phone}).then(function(t){var n=t.data.data,i=Object.create(null);i={member_id:n.member_id,member_token:n.member_token,phone:e.phone,nickname:e.nickname,avatar:e.head_img},wx.setStorageSync("memberInfo",i),e.joinKey?wx.reLaunch({url:"joinClass?classId="+e.classId+"&name="+e.name+"&key="+e.joinKey}):wx.reLaunch({url:"classList"})})}},{key:"onLoad",value:function(e){var t=this;this.joinKey=e.key,this.classId=e.classId,this.name=e.name,this.$apply(),wx.login({success:function(e){var n=wx.getStorageSync("wxtoken");(0,_login.getSessionKey)({code:e.code,old_wxapp_token:n}).then(function(e){var n=e.data;t.unionid=n.unionid?n.unionid:"",t.wxtoken=n.wxapp_token,t.openid=n.openid,t.$apply(),wx.setStorageSync("wxtoken",t.wxtoken)})}})}}]),t}(_wepy2.default.page);Page(require("./../npm/wepy/lib/wepy.js").default.$createPage(login,"pages/login"));