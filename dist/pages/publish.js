"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),_wepy=require("./../npm/wepy/lib/wepy.js"),_wepy2=_interopRequireDefault(_wepy),_wepyRedux=require("./../npm/wepy-redux/lib/index.js"),_actions=require("./../store/actions/index.js"),_modal=require("./../components/modal.js"),_modal2=_interopRequireDefault(_modal),_modal3=require("./../components/modal2.js"),_modal4=_interopRequireDefault(_modal3),_common=require("./../utils/common.js"),_zone=require("./../api/zone.js"),store=(0,_wepyRedux.getStore)(),Publish=function(e){function t(){var e,i,n,o;_classCallCheck(this,t);for(var s=arguments.length,a=Array(s),r=0;r<s;r++)a[r]=arguments[r];return i=n=_possibleConstructorReturn(this,(e=t.__proto__||Object.getPrototypeOf(t)).call.apply(e,[this].concat(a))),n.config={navigationBarTitleText:"发布"},n.$repeat={},n.$props={Modal:{sureBtnText:"添加完成",cancelBtnText:"再添加一项",placeholderText:"请输入您想新增的活动项目名","xmlns:v-bind":"","v-bind:flag.sync":"showAddActivity","xmlns:v-on":""},Modal2:{sureBtnText:"添加完成",cancelBtnText:"再添加一项",placeholderText:"收款选项名",placeholderText2:"金额","v-bind:flag.sync":"showAddMoney"}},n.$events={Modal:{"v-on:cancel":"cancel","v-on:sure":"sure"},Modal2:{"v-on:cancel":"cancel","v-on:sure":"moneySureFn"}},n.components={Modal:_modal2.default,Modal2:_modal4.default},n.data={showAddActivity:!1,showAddMoney:!1,msg:"",img:[],seeType:0,activityType:0,activityJoinType:[{id:0,title:"单选",type:"radio"},{id:1,title:"多选",type:"select"}],remindType:[{id:0,title:"否"},{id:1,title:"是"}],type:[{id:0,title:"班级可见",type:"class"},{id:1,title:"全部可见",type:"all"}],typeList:{zone:"家长圈",notice:"通知",activity:"活动",money:"收款"},placeholder:"请在此发表您的感想",activeType:"zone",activityList:[],canSubmit:!1,memberInfo:null,classInfo:null,money:"",isRemind:1,moneyList:[],maxPhotoCount:9,uploads:[]},n.onLoad=function(e){n.classInfo=wx.getStorageSync("classInfo"),n.memberInfo=wx.getStorageSync("memberInfo");var t=e.type;wx.setNavigationBarTitle({title:"发布"+n.typeList[t]}),"zone"!==t&&(n.placeholder="请在此录入您的"+n.typeList[t]+"详情"),n.activeType=t,n.$apply()},n.watch={msg:function(e,t){(0,_common.isEmptyString)(e)||(this.canSubmit=!0),this.$apply()}},n.methods={selectSeeType:function(e){this.seeType=e,this.$apply()},chooseImage:function(){var e=this;if(this.img.length>this.maxPhotoCount)return void(0,_common.showMsg)("最多上传9张图");var t=this;wx.chooseImage({count:this.maxPhotoCount,sizeType:["original","compressed"],sourceType:["album","camera"],success:function(i){var n=i.tempFilePaths.length,o=[];e.img.length+n>e.maxPhotoCount&&wx.showToast({title:"最多只能选择"+e.maxPhotoCount+"张图片",icon:"none"}),wx.showLoading({title:"图片上传中"}),i.tempFilePaths.forEach(function(i){var s={};s.path=i,s.error=!1,s.uploadProgress=wx.uploadFile({url:_wepy2.default.$appConfig.baseUrl+"/file/uploadPic",filePath:i,formData:{member_id:e.memberInfo.member_id,member_token:e.memberInfo.member_token,folder:"committee"},name:"file",success:function(e){var i=JSON.parse(e.data);if(i.data&&i.data.file_url){var s=i.data.file_url;o.push(s),t.img.push(s)}o.length===n&&setTimeout(function(){wx.hideLoading()},1e3),t.$apply()}}),s.uploadProgress.onProgressUpdate(function(e){s.progress=e.progress}),t.uploads.push(s),t.$apply()})}})},submit:function(){this.checkCanSubmit();var e=Object.assign({},{class_id:this.classInfo.id,type:this.seenIndex,desc:this.msg});"zone"===this.activeType||"money"===this.activeType?this.saveCircles(e,this.activeType):"activity"===this.activeType?this.saveActivity(e):"notice"===this.activeType&&this.saveNotice(e)},cancel:function(){this.showAddActivity=!1,this.showAddMoney=!1,this.$apply()},sure:function(e,t){if(this.checkRepeat(e,this.activityList))return void(0,_common.showMsg)("请不要输入重复的活动项目");(0,_common.showMsg)("添加成功",1e3);var i={name:e};this.activityList.push(i),"save"===t&&(this.showAddActivity=!1),this.$apply()},moneySureFn:function(e,t,i){if(Number(t)<=0)return void(0,_common.showMsg)("请输入合法金额");(0,_common.showMsg)("添加成功",1e3);var n={name:e,money:Number(t)};this.moneyList.push(n),"save"===i&&(this.showAddMoney=!1),this.$apply()},addNew:function(e){this[e]=!0,this.$apply()},deleteFn:function(e,t){this[e].splice(t,1),this.$apply()},bindChange:function(e){this[e.currentTarget.id]=e.detail.value,this.$apply()}},o=i,_possibleConstructorReturn(n,o)}return _inherits(t,e),_createClass(t,[{key:"commonFn",value:function(e){e.data.success&&((0,_actions.setFromPublish)(!0),(0,_common.showMsg)("发布成功",2e3),setTimeout(function(){wx.navigateBack()},2e3))}},{key:"checkCanSubmit",value:function(){var e="请填写您的"+this.typeList[this.activeType]+"描述详情";return!(0,_common.isEmptyString)(this.msg)||((0,_common.showMsg)(e),!1)}},{key:"saveCircles",value:function(e,t){var i=this,n=Object.assign({},e,{img_url:this.img}),o=Object.assign({},n,{see_type:this.type[this.seeType].type});if("money"===t){if(!this.moneyList.length)return void(0,_common.showMsg)("请至少添加一个收款条目");var s=Object.assign({},n,{item:this.moneyList,type:"student"});(0,_zone.addCollection)(s).then(function(e){i.commonFn(e)})}else(0,_zone.addCircles)(o).then(function(e){i.commonFn(e)})}},{key:"saveActivity",value:function(e){var t=this;if(!this.activityList.length)return void(0,_common.showMsg)("请至少添加一个活动选项");var i=Object.assign({},e,{selectType:this.activityJoinType[this.activityType].type,sign_type:"all",item:this.activityList,img_url:this.img});(0,_zone.addActivity)(i).then(function(e){t.commonFn(e)})}},{key:"saveNotice",value:function(e){var t=this,i=Object.assign({},e,{remind:Number(this.isRemind)});(0,_zone.addNotify)(i).then(function(e){t.commonFn(e)})}},{key:"checkRepeat",value:function(e,t){for(var i=!1,n=0,o=t.length;n<o;n++){if(t[n].name===e){i=!0;break}i=!1}return i}}]),t}(_wepy2.default.page);Page(require("./../npm/wepy/lib/wepy.js").default.$createPage(Publish,"pages/publish"));