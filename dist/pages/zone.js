"use strict";var __extends=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])};return function(e,n){function i(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}(),__decorate=this&&this.__decorate||function(t,e,n,i){var o,s=arguments.length,r=s<3?e:null===i?i=Object.getOwnPropertyDescriptor(e,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,n,i);else for(var a=t.length-1;a>=0;a--)(o=t[a])&&(r=(s<3?o(r):s>3?o(e,n,r):o(e,n))||r);return s>3&&r&&Object.defineProperty(e,n,r),r};Object.defineProperty(exports,"__esModule",{value:!0});var replyCommentData={idx:"",memberId:"",memberName:"",type:""},wepy_1=require("./../npm/wepy/lib/wepy.js"),wepy_redux_1=require("./../npm/wepy-redux/lib/index.js"),actions_1=require("./../store/actions/index.js"),selectModal_1=require("./../components/selectModal.js"),commentModal_1=require("./../components/commentModal.js"),sureModal_1=require("./../components/sureModal.js"),shareModal_1=require("./../components/shareModal.js"),common_1=require("./../utils/common.js"),zone_1=require("./../api/zone.js"),finance_1=require("./../api/finance.js"),authorize_1=require("./../api/authorize.js"),user_1=require("./../api/user.js"),store=wepy_redux_1.getStore(),Zone=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.config={navigationBarTitleText:"最近班级",enablePullDownRefresh:!0},e.$repeat={},e.$props={CurrentModal:{sureBtnText:"确认",cancelBtnText:"取消",placeholderText:"请输入评论内容","xmlns:v-bind":"","v-bind:flag.sync":"commentFlag","v-bind:commentInput.sync":"commentInput","xmlns:v-on":""},SelectModal:{"v-bind:flag.sync":"selectFlag","v-bind:list.sync":"payMemberList"},shareModal:{"v-bind:flag.sync":"showShareFlag","v-bind:title.sync":"shareTitle","v-bind:imgSrc.sync":"shareImg"},SureModal:{"v-bind:flag.sync":"showSureFlag","v-bind:title.sync":"removeCircleTitle"}},e.$events={CurrentModal:{"v-on:cancel":"commentCancel","v-on:sure":"commentSure","v-on:input":"bindCommentInput"},SelectModal:{"v-on:cancel":"toggleFlag","v-on:sure":"selectSure"},shareModal:{"v-on:cancel":"toggleFlag","v-on:sure":"toggleFlag"},SureModal:{"v-on:cancel":"toggleFlag","v-on:sure":"toggleFlag"}},e.components={CurrentModal:commentModal_1.default,SelectModal:selectModal_1.default,shareModal:shareModal_1.default,SureModal:sureModal_1.default},e.data={menuList:[{text:"通知",type:"notice",src:"/images/icon/4.jpg"},{text:"活动",type:"activity",src:"/images/icon/5.jpg"},{text:"家长圈",type:"zone",src:"/images/icon/2.jpg"},{text:"收款",type:"money",src:"/images/icon/money.jpg"},{text:"记账",type:"account",src:"/images/icon/photos.jpg"}],showSureFlag:!1,commentFlag:!1,selectFlag:!1,activeType:"all",setFlag:!1,publishFlag:!1,type:{circles:"家长圈",collection:"收款",notify:"通知",activity:"活动",account:"记账"},gradeType:{primary:"小学",middle:"初中",high:"高中",university:"大学"},shareImgSrc:{circles:"../images/share/circles.jpg",collection:"../images/share/collection.jpg",notify:"../images/share/notify.jpg",activity:"../images/share/activity.jpg",account:"../images/share/account.jpg"},pn:1,ps:10,list:[],payMemberList:[],classInfo:null,memberInfo:null,schoolInfo:null,loading:!1,loadFinished:!1,commentInput:"",currentReplyId:-1,currentReplyRootId:-1,currentReplyToCommentId:-1,currerntJoinAcitivytId:-1,currerntSubActivityId:[],currentCollectionId:-1,auth:{president:!1,finance:!1,activity:!1,notify:!1,photos:!1,circles:!1},commentPn:2,commentPs:6,commentOffset:6,commentLoadFinished:!1,memberList:[],studentIds:[],firstInit:!0,paymentLocked:!1,loadMoreCommentArray:[],shareTitle:"",showShareFlag:!1,shareImg:"",removeCircleTitle:"您确认要删除吗？",currentRemoveMomentId:-1,currentRemoveMomentIdx:-1,currentToCommentId:-1},e.watch={currentJoinActivityId:function(t,e){t>0&&(this.currerntSubActivityId=[],this.$apply())}},e.methods={addLike:function(t,e,n){var i=this;if(!this.classInfo&&!this.classInfo.id)return void common_1.showMsg("请先加入班级");zone_1.addLike({class_id:this.classInfo.id,moment_id:t}).then(function(o){if(o.data.success){n?(common_1.showMsg("取消点赞成功"),i.list[e].like_list.count--):(common_1.showMsg("点赞成功"),i.list[e].like_list.count++),i.list[e].is_like=!n;var s={moment_id:t,member_id:i.memberInfo.member_id,member:i.memberInfo};i.list[e].like_list.list=common_1.filterArrayByValue(i.memberInfo.member_id,i.list[e].like_list.list,n,s),i.$apply()}})},toggleFlag:function(t,e){this[t]=e,"showSureFlag"===t&&e&&(this[t]=!1,this.removeCircleFn(this.currentRemoveMomentId,this.currentRemoveMomentIdx)),this.$apply()},shareCircle:function(t){var e=this.getShareActionType(t),n=this.getShareType(t);this.shareTitle=this.memberInfo.nickname+"分享了一个"+n+"，点击"+e,this.shareImg=this.shareImgSrc[t],this.showShareFlag=!0,this.$apply()},removeCircle:function(t,e){this.showSureFlag=!0,this.currentRemoveMomentId=t,this.currentRemoveMomentIdx=e,this.$apply()},pay:function(t,e){var n=this;this.paymentLocked||(this.paymentLocked=!0,user_1.checkStudent({class_id:this.classInfo.id,moment_id:t,is_pay:0}).then(function(t){if(n.payMemberList=t.data.list,!n.payMemberList.length)return n.paymentLocked=!1,n.$apply(),void common_1.showMsg("请勿重复缴费");n.payMemberList.length>1?(n.selectFlag=!0,n.currentCollectionId=e,n.$apply()):(n.studentIds=[],n.studentIds.push(n.payMemberList[0].id),n.addToOrder(e))}))},submitJoinActivity:function(){var t=this;if(this.currerntJoinAcitivytId<=0)return void common_1.showMsg("请先选择活动项目");zone_1.joinActivity({class_id:this.classInfo.id,activity_item_id:this.currerntSubActivityId,activity_id:this.currerntJoinAcitivytId}).then(function(e){e.data.success&&(common_1.showMsg("提交成功"),t.currerntSubActivityId=[],t.$apply())})},joinActivity:function(t,e,n,i){if(!this.classInfo)return void common_1.showMsg("请先选择班级");this.currerntJoinAcitivytId=t;var o=this.currerntSubActivityId.indexOf(e);o>-1?(this.currerntSubActivityId.splice(o,1),this.list[n].info.item[i].checked=!1):(this.currerntSubActivityId.push(e),this.list[n].info.item[i].checked=!0),this.$apply()},loadMoreComment:function(t,e){var n=this,i=this.findLoadmoreCommentInfo(this.loadMoreCommentArray,t);zone_1.getCommentList({moment_id:t,ps:this.commentPs,pn:i.commentPn?i.commentPn:this.commentPn,offset:this.commentOffset}).then(function(o){if(o.data.success){var s=o.data.list,r=n.list[e].comment_list.list;if(r=r.concat(s),n.list[e].comment_list.list=r,s.length<n.commentPs&&(n.list[e].commentLoadFinished=!0),i.commentPn)n.loadMoreCommentArray[i.index].commentPn=i.commentPn+1;else{var a={commentPn:n.commentPn+1,moment_id:t};n.loadMoreCommentArray.push(a)}n.$apply()}})},addComment:function(t,e,n,i,o,s,r){return console.log(arguments),replyCommentData.idx=e,replyCommentData.type=t,replyCommentData.memberId=r,replyCommentData.memberName=s,this.classInfo?r===this.memberInfo.member_id?void common_1.showMsg("请不要回复自己"):(this.commentFlag=!0,this.currentReplyId=n,this.currentReplyRootId="add"===t?0:i,this.currentToCommentId=o,this.commentInput=void 0!==s?"@"+s+":":"",void this.$apply()):void common_1.showMsg("请先选择班级")},bindCommentInput:function(t){this.commentInput=t,this.$apply()},commentSure:function(){var t=this;this.commentFlag=!1,zone_1.addComment({class_id:this.classInfo.id,moment_id:this.currentReplyId,content:this.currentReplyId>0?this.commentInput.replace(/^@.+:/,""):this.commentInput,root_id:this.currentReplyRootId,to_comment_id:this.currentToCommentId}).then(function(e){if(e.data.success){var n=replyCommentData.idx,i=replyCommentData.memberId,o=replyCommentData.memberName,s=replyCommentData.type;t.insertComment({idx:n,memberId:i,memberName:o,type:s,content:t.currentReplyId>0?t.commentInput.replace(/^@.+:/,""):t.commentInput,toCommentId:t.currentToCommentId}),t.commentInput="",t.$apply()}})},jumpPublish:function(t){if(!this.classInfo)return void common_1.showMsg("请选绑定班级",3e3);if("account"===t&&!this.auth.finance)return void common_1.showMsg("您没有财务权限",3e3);var e="account"===t?"recordCashflow":"publish?type="+t;wx.navigateTo({url:e})},commentCancel:function(){this.commentFlag=!1,this.commentInput="",this.$apply()},jumpPage:function(t,e){this.publishFlag=!1,this.setFlag=!1,wx.navigateTo({url:t+"?type="+e})},toggleMenu:function(t){if(!this.classInfo)return void common_1.showMsg("请选绑定班级",3e3);this[t]=!this[t],this.$apply()},closeToggle:function(){this.setFlag=!1,this.publishFlag=!1,this.$apply()},preview:function(t,e){common_1.previewImage(t,e)},selectSure:function(t){if(!t.length)return void common_1.showMsg("请选择");var e=t;this.studentIds=e.slice(),this.selectFlag=!1,this.$apply(),this.addToOrder(this.currentCollectionId)}},e}return __extends(e,t),e.prototype.resetData=function(){this.loading=!1,this.loadFinished=!1,this.loadMoreCommentArray=[],this.commentLoadFinished=!1,this.currentRemoveMomentId=-1,this.currentRemoveMomentIdx=-1,this.currentToCommentId=-1,this.commentPn=2,this.commentPs=6,this.studentIds=[],this.paymentLocked=!1,this.pn=1,this.list=[],this.$apply()},e.prototype.onPullDownRefresh=function(){this.resetData(),this.getZoneList()},e.prototype.onReachBottom=function(){this.loading||this.loadFinished||this.getZoneList()},e.prototype.onShow=function(){this.currerntJoinAcitivytId=-1,this.currerntSubActivityId=[],this.classHasChanged&&(this.memberInfo=wx.getStorageSync("memberInfo"),this.classInfo=wx.getStorageSync("classInfo"),this.resetData(),this.getAuthList(),this.getZoneList(),this.$parent.globalData.userData=this.memberInfo,actions_1.setClassChanged(!1)),this.$apply(),this.fromPublish&&(this.resetData(),this.getZoneList(),actions_1.setFromPublish(!1))},e.prototype.onLoad=function(){this.checkDataExist("memberInfo")?(this.classInfo=wx.getStorageSync("classInfo"),this.classInfo&&this.getAuthList(),this.memberInfo=wx.getStorageSync("memberInfo"),this.$parent.globalData.userData=this.memberInfo,this.$apply(),this.getZoneList()):wx.reLaunch({url:"login"})},e.prototype.removeCircleFn=function(t,e){var n=this;zone_1.deleteCircle({moment_id:t,class_id:this.classInfo.id}).then(function(t){t.data.success&&(common_1.showMsg("成功删除"),n.list.splice(e,1),n.$apply())})},e.prototype.getAuthList=function(){var t=this;authorize_1.getAuth({class_id:this.classInfo.id}).then(function(e){t.checkAuth(e.data.data)})},e.prototype.formatAllAuth=function(t){Object.keys(t).forEach(function(e){t[e]=!0}),this.$apply()},e.prototype.formatSingleAuth=function(t,e){this.auth[t]=e,this.$apply()},e.prototype.checkAuth=function(t){for(var e=0,n=t.length;e<n;e++){var i=t[e],o=i.code,s=i.is_auth;if("president"===o&&s){actions_1.setPresident(!0),this.formatAllAuth(this.auth);break}actions_1.setPresident(!1),s&&this.formatSingleAuth(o,!0),!s&&this.formatSingleAuth(o,!1)}},e.prototype.checkDataExist=function(t){return!!wx.getStorageSync(t)},e.prototype.getZoneList=function(t){var e=this;this.loading=!0,this.$apply();var n=this.classInfo.id;zone_1.getCircleList({class_id:n,see_type:n?"":"all",type:this.activeType,pn:this.pn,ps:this.ps,comment_count:3}).then(function(t){var n=t.data.list;e.loading=!1,e.pn++,n.length<e.ps&&(e.loadFinished=!0),e.list=e.list.concat(n),e.$apply()})},e.prototype.paymentParams=function(t){var e=this;finance_1.getPaymentParams({order_id:t}).then(function(t){var n=e,i=t.data.payment_params;wx.requestPayment({timeStamp:String(i.timeStamp),nonceStr:i.nonceStr,package:i.package,paySign:i.paySign,signType:"MD5",success:function(){n.paymentLocked=!1,n.$apply()},fail:function(){n.paymentLocked=!1,n.$apply()}})})},e.prototype.addToOrder=function(t){var e=this;finance_1.addOrder({class_id:this.classInfo.id,student_ids:this.studentIds,collection_item_id:t}).then(function(t){e.paymentParams(t.data.data.id)})},e.prototype.findLoadmoreCommentInfo=function(t,e){for(var n={},i=0,o=t.length;i<o;i++)t[i].moment_id===e&&(n=Object.assign({},t[i],{index:i}));return n},e.prototype.getShareActionType=function(t){var e="浏览";switch(t){case"activity":return e="参加";case"collection":return e="缴费";default:return e}},e.prototype.getShareType=function(t){return"circles"===t?"家长圈图文":"家委会"+this.type[t]},e.prototype.insertComment=function(t){var e=t.idx,n=t.memberId,i=t.memberName,o=t.content,s=t.toCommentId,r={member:this.memberInfo,to_member:{id:n,class_nickname:i},root_id:null,content:o,to_comment_id:s};this.list[e].comment_list.list.push(r),this.list[e].comment_list.count++,this.$apply()},e.prototype.onShareAppMessage=function(t){return{title:this.shareTitle,imageUrl:this.shareImg}},e=__decorate([wepy_redux_1.connect({fromPublish:function(t){return t.zone.from_publish},classHasChanged:function(t){return t.zone.classChanged}})],e)}(wepy_1.default.page);Page(require("./../npm/wepy/lib/wepy.js").default.$createPage(Zone,"pages/zone"));