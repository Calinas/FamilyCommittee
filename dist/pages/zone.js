"use strict";var __extends=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function o(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),__assign=this&&this.__assign||Object.assign||function(e){for(var t,n=1,o=arguments.length;n<o;n++){t=arguments[n];for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])}return e},__decorate=this&&this.__decorate||function(e,t,n,o){var i,s=arguments.length,r=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,n):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(e,t,n,o);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(r=(s<3?i(r):s>3?i(t,n,r):i(t,n))||r);return s>3&&r&&Object.defineProperty(t,n,r),r};Object.defineProperty(exports,"__esModule",{value:!0});var replyCommentData={idx:"",memberId:"",memberName:"",type:""},wepy_1=require("./../npm/wepy/lib/wepy.js"),wepy_redux_1=require("./../npm/wepy-redux/lib/index.js"),actions_1=require("./../store/actions/index.js"),selectModal_1=require("./../components/selectModal.js"),commentModal_1=require("./../components/commentModal.js"),sureModal_1=require("./../components/sureModal.js"),shareModal_1=require("./../components/shareModal.js"),common_1=require("./../utils/common.js"),zone_1=require("./../api/zone.js"),finance_1=require("./../api/finance.js"),authorize_1=require("./../api/authorize.js"),user_1=require("./../api/user.js"),store=wepy_redux_1.getStore(),Zone=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.config={navigationBarTitleText:"最近班级",enablePullDownRefresh:!0},t.$repeat={},t.$props={CurrentModal:{sureBtnText:"确认",cancelBtnText:"取消",placeholderText:"请输入评论内容","xmlns:v-bind":"","v-bind:flag.sync":"commentFlag","v-bind:commentInput.sync":"commentInput","xmlns:v-on":""},SelectModal:{"v-bind:flag.sync":"selectFlag","v-bind:list.sync":"payMemberList"},shareModal:{"v-bind:flag.sync":"showShareFlag","v-bind:title.sync":"shareTitle","v-bind:imgSrc.sync":"shareImg"},SureModal:{"v-bind:flag.sync":"showSureFlag","v-bind:title.sync":"removeCircleTitle"},deleteRecordModal:{sureBtnText:"确认",cancelBtnText:"取消",placeholderText:"请输入撤销原因","v-bind:flag.sync":"deleteRecordFlag","v-bind:commentInput.sync":"deleteRecordInput"}},t.$events={CurrentModal:{"v-on:cancel":"commentCancel","v-on:sure":"commentSure","v-on:input":"bindCommentInput"},SelectModal:{"v-on:cancel":"toggleFlag","v-on:sure":"selectSure"},shareModal:{"v-on:cancel":"toggleFlag","v-on:sure":"toggleFlag"},SureModal:{"v-on:cancel":"toggleFlag","v-on:sure":"toggleFlag"},deleteRecordModal:{"v-on:cancel":"deleteCancel","v-on:sure":"deleteSure","v-on:input":"bindDeleteInput"}},t.components={CurrentModal:commentModal_1.default,SelectModal:selectModal_1.default,shareModal:shareModal_1.default,SureModal:sureModal_1.default,deleteRecordModal:commentModal_1.default},t.data={menuList:[{text:"通知",type:"notice",src:"/images/icon/4.jpg"},{text:"活动",type:"activity",src:"/images/icon/5.jpg"},{text:"家长圈",type:"zone",src:"/images/icon/2.jpg"},{text:"收款",type:"money",src:"/images/icon/money.jpg"},{text:"记账",type:"account",src:"/images/icon/photos.jpg"}],deleteRecordFlag:!1,showSureFlag:!1,commentFlag:!1,selectFlag:!1,activeType:"circles,collection,notify,activity,account,system",setFlag:!1,publishFlag:!1,type:{circles:"家长圈",collection:"收款",notify:"通知",activity:"活动",account:"记账",system:"圈子"},gradeType:{primary:"小学",middle:"初中",high:"高中",university:"大学"},shareImgSrc:{circles:"../images/share/circles.jpg",collection:"../images/share/collection.jpg",notify:"../images/share/notify.jpg",activity:"../images/share/activity.jpg",account:"../images/share/account.jpg"},pn:1,ps:10,list:[],payMemberList:[],classInfo:null,memberInfo:null,schoolInfo:null,loading:!1,loadFinished:!1,commentInput:"",deleteRecordInput:"",currentReplyId:-1,currentReplyRootId:-1,currentReplyToCommentId:-1,currerntJoinAcitivytId:-1,currerntSubActivityId:[],currentCollectionId:-1,auth:{president:!1,finance:!1,activity:!1,notify:!1,photos:!1,circles:!1},commentPn:2,commentPs:6,commentOffset:6,commentLoadFinished:!1,memberList:[],studentIds:[],firstInit:!0,paymentLocked:!1,loadMoreCommentArray:[],shareTitle:"",showShareFlag:!1,shareImg:"",removeCircleTitle:"您确认要删除吗？",currentRemoveMomentId:-1,currentRemoveMomentIdx:-1,currentToCommentId:-1},t.watch={currentJoinActivityId:function(e,t){e>0&&(this.currerntSubActivityId=[],this.$apply())}},t.methods={addLike:function(e,t,n){var o=this;if(!this.classInfo&&!this.classInfo.id)return void common_1.showMsg("请先加入班级");zone_1.addLike({class_id:this.classInfo.id,moment_id:e}).then(function(i){if(i.data.success){n?(common_1.showMsg("取消点赞成功"),o.list[t].like_list.count--):(common_1.showMsg("点赞成功"),o.list[t].like_list.count++),o.list[t].is_like=!n;var s={moment_id:e,member_id:o.memberInfo.member_id,member:o.memberInfo};o.list[t].like_list.list=common_1.filterArrayByValue(o.memberInfo.member_id,o.list[t].like_list.list,n,s),o.$apply()}})},toggleFlag:function(e,t){this[e]=t,"showSureFlag"===e&&t&&(this[e]=!1,this.removeCircleFn(this.currentRemoveMomentId,this.currentRemoveMomentIdx)),this.$apply()},shareCircle:function(e){var t=this.getShareActionType(e),n=this.getShareType(e);this.shareTitle=this.memberInfo.nickname+"分享了一个"+n+"，点击"+t,this.shareImg=this.shareImgSrc[e],this.showShareFlag=!0,this.$apply()},removeCircle:function(e,t){this.showSureFlag=!0,this.currentRemoveMomentId=e,this.currentRemoveMomentIdx=t,this.$apply()},removeRecord:function(e,t){this.deleteRecordFlag=!0,this.currentRemoveMomentId=e,this.currentRemoveMomentIdx=t,this.$apply()},pay:function(e,t){var n=this;this.paymentLocked||(this.paymentLocked=!0,user_1.checkStudent({class_id:this.classInfo.id,moment_id:e,is_pay:0}).then(function(e){if(n.payMemberList=e.data.list,!n.payMemberList.length)return n.paymentLocked=!1,n.$apply(),void common_1.showMsg("请勿重复缴费");n.payMemberList.length>1?(n.selectFlag=!0,n.currentCollectionId=t,n.$apply()):(n.studentIds=[],n.studentIds.push(n.payMemberList[0].id),n.addToOrder(t))}))},submitJoinActivity:function(){var e=this;if(this.currerntJoinAcitivytId<=0)return void common_1.showMsg("请先选择活动项目");zone_1.joinActivity({class_id:this.classInfo.id,activity_item_id:this.currerntSubActivityId,activity_id:this.currerntJoinAcitivytId}).then(function(t){t.data.success&&(common_1.showMsg("提交成功"),e.currerntSubActivityId=[],e.$apply())})},joinActivity:function(e,t,n,o){if(!this.classInfo)return void common_1.showMsg("请先选择班级");this.currerntJoinAcitivytId=e;var i=this.currerntSubActivityId.indexOf(t);i>-1?(this.currerntSubActivityId.splice(i,1),this.list[n].info.item[o].checked=!1):(this.currerntSubActivityId.push(t),this.list[n].info.item[o].checked=!0),this.$apply()},loadMoreComment:function(e,t){var n=this,o=this.findLoadmoreCommentInfo(this.loadMoreCommentArray,e);zone_1.getCommentList({moment_id:e,ps:this.commentPs,pn:o.commentPn?o.commentPn:this.commentPn,offset:this.commentOffset}).then(function(i){if(i.data.success){var s=i.data.list,r=n.list[t].comment_list.list;if(r=r.concat(s),n.list[t].comment_list.list=r,s.length<n.commentPs&&(n.list[t].commentLoadFinished=!0),o.commentPn)n.loadMoreCommentArray[o.index].commentPn=o.commentPn+1;else{var a={commentPn:n.commentPn+1,moment_id:e};n.loadMoreCommentArray.push(a)}n.$apply()}})},addComment:function(e,t,n,o,i,s,r){return console.log(arguments),replyCommentData.idx=t,replyCommentData.type=e,replyCommentData.memberId=r,replyCommentData.memberName=s,this.classInfo?r===this.memberInfo.member_id?void common_1.showMsg("请不要回复自己"):(this.commentFlag=!0,this.currentReplyId=n,this.currentReplyRootId="add"===e?0:o,this.currentToCommentId=i,this.commentInput=void 0!==s?"@"+s+":":"",void this.$apply()):void common_1.showMsg("请先选择班级")},bindCommentInput:function(e){this.commentInput=e,this.$apply()},bindDeleteInput:function(e){this.deleteRecordInput=e,this.$apply()},commentSure:function(){var e=this;this.commentFlag=!1,zone_1.addComment({class_id:this.classInfo.id,moment_id:this.currentReplyId,content:this.currentReplyId>0?this.commentInput.replace(/^@.+:/,""):this.commentInput,root_id:this.currentReplyRootId,to_comment_id:this.currentToCommentId}).then(function(t){if(t.data.success){var n=replyCommentData.idx,o=replyCommentData.memberId,i=replyCommentData.memberName,s=replyCommentData.type;e.insertComment({idx:n,memberId:o,memberName:i,type:s,content:e.currentReplyId>0?e.commentInput.replace(/^@.+:/,""):e.commentInput,toCommentId:e.currentToCommentId}),e.commentInput="",e.$apply()}})},jumpPublish:function(e){if(!this.classInfo)return void common_1.showMsg("请选绑定班级",3e3);if("account"===e&&!this.auth.finance)return void common_1.showMsg("您没有财务权限",3e3);var t="account"===e?"recordCashflow":"publish?type="+e;wx.navigateTo({url:t})},commentCancel:function(){this.commentFlag=!1,this.commentInput="",this.$apply()},deleteCancel:function(){this.deleteRecordFlag=!1,this.deleteRecordInput="",this.$apply()},deleteSure:function(){this.removeRecordFn(this.currentRemoveMomentId,this.currentRemoveMomentIdx),this.deleteRecordFlag=!1,this.$apply()},jumpPage:function(e,t){this.publishFlag=!1,this.setFlag=!1,wx.navigateTo({url:e+"?type="+t})},toggleMenu:function(e){if(!this.classInfo)return void common_1.showMsg("请选绑定班级",3e3);this[e]=!this[e],this.$apply()},closeToggle:function(){this.setFlag=!1,this.publishFlag=!1,this.$apply()},preview:function(e,t){common_1.previewImage(e,t)},selectSure:function(e){if(!e.length)return void common_1.showMsg("请选择");var t=e;this.studentIds=t.slice(),this.selectFlag=!1,this.$apply(),this.addToOrder(this.currentCollectionId)}},t}return __extends(t,e),t.prototype.resetData=function(){this.loading=!1,this.loadFinished=!1,this.loadMoreCommentArray=[],this.commentLoadFinished=!1,this.currentRemoveMomentId=-1,this.currentRemoveMomentIdx=-1,this.currentToCommentId=-1,this.commentPn=2,this.commentPs=6,this.studentIds=[],this.paymentLocked=!1,this.pn=1,this.list=[],this.$apply()},t.prototype.onPullDownRefresh=function(){this.resetData(),this.getZoneList()},t.prototype.onReachBottom=function(){this.loading||this.loadFinished||this.getZoneList()},t.prototype.onShow=function(){this.currerntJoinAcitivytId=-1,this.currerntSubActivityId=[],this.classHasChanged&&(this.memberInfo=wx.getStorageSync("memberInfo"),this.classInfo=wx.getStorageSync("classInfo"),this.resetData(),this.getAuthList(),this.getZoneList(),this.$parent.globalData.userData=this.memberInfo,actions_1.setClassChanged(!1)),this.$apply(),this.fromPublish&&(this.resetData(),this.getZoneList(),actions_1.setFromPublish(!1))},t.prototype.onLoad=function(){if(this.checkDataExist("memberInfo")){if(!this.classHasChanged){if(this.classInfo=wx.getStorageSync("classInfo"),this.classInfo&&this.getAuthList(),this.memberInfo=wx.getStorageSync("memberInfo"),this.memberInfo&&-1===this.memberInfo.member_id)return;this.$parent.globalData.userData=this.memberInfo,this.$apply(),this.getZoneList()}}else wx.reLaunch({url:"login"})},t.prototype.removeRecordFn=function(e,t){var n=this;zone_1.deleteRecord({moment_id:e,class_id:this.classInfo.id,undo_msg:this.deleteRecordInput}).then(function(e){e.data.success&&(common_1.showMsg("撤销成功"),n.list[t].deleted_at="刚刚",n.list[t].info=__assign({},n.list[t].info,{undo_msg:n.deleteRecordInput}),n.deleteRecordInput="",n.$apply())})},t.prototype.removeCircleFn=function(e,t){var n=this;zone_1.deleteCircle({moment_id:e,class_id:this.classInfo.id}).then(function(e){e.data.success&&(common_1.showMsg("成功删除"),n.list.splice(t,1),n.$apply())})},t.prototype.getAuthList=function(){var e=this;authorize_1.getAuth({class_id:this.classInfo.id}).then(function(t){e.checkAuth(t.data.data)})},t.prototype.formatAllAuth=function(e){Object.keys(e).forEach(function(t){e[t]=!0}),this.$apply()},t.prototype.formatSingleAuth=function(e,t){this.auth[e]=t,this.$apply()},t.prototype.checkAuth=function(e){for(var t=0,n=e.length;t<n;t++){var o=e[t],i=o.code,s=o.is_auth;if("president"===i&&s){actions_1.setPresident(!0),this.formatAllAuth(this.auth);break}actions_1.setPresident(!1),s&&this.formatSingleAuth(i,!0),!s&&this.formatSingleAuth(i,!1)}},t.prototype.checkDataExist=function(e){return!!wx.getStorageSync(e)},t.prototype.getZoneList=function(e){var t=this;this.loading=!0,this.$apply();var n=this.classInfo.id;zone_1.getCircleList({class_id:n,see_type:n?"":"all",type:this.activeType,pn:this.pn,ps:this.ps,comment_count:3}).then(function(e){var n=e.data.list;t.loading=!1,t.pn++,n.length<t.ps&&(t.loadFinished=!0),t.list=t.list.concat(n),t.$apply()})},t.prototype.paymentParams=function(e){var t=this;finance_1.getPaymentParams({order_id:e}).then(function(e){var n=t,o=e.data.payment_params;wx.requestPayment({timeStamp:String(o.timeStamp),nonceStr:o.nonceStr,package:o.package,paySign:o.paySign,signType:"MD5",success:function(){n.paymentLocked=!1,n.$apply()},fail:function(){n.paymentLocked=!1,n.$apply()}})})},t.prototype.addToOrder=function(e){var t=this;finance_1.addOrder({class_id:this.classInfo.id,student_ids:this.studentIds,collection_item_id:e}).then(function(e){t.paymentParams(e.data.data.id)})},t.prototype.findLoadmoreCommentInfo=function(e,t){for(var n={},o=0,i=e.length;o<i;o++)e[o].moment_id===t&&(n=Object.assign({},e[o],{index:o}));return n},t.prototype.getShareActionType=function(e){var t="浏览";switch(e){case"activity":return t="参加";case"collection":return t="缴费";default:return t}},t.prototype.getShareType=function(e){return"circles"===e?"家长圈图文":"家委会"+this.type[e]},t.prototype.insertComment=function(e){var t=e.idx,n=e.memberId,o=e.memberName,i=e.content,s=e.toCommentId,r={member:this.memberInfo,to_member:{id:n,class_nickname:o},root_id:null,content:i,to_comment_id:s};this.list[t].comment_list.list.push(r),this.list[t].comment_list.count++,this.$apply()},t.prototype.onShareAppMessage=function(e){return{title:this.shareTitle,imageUrl:this.shareImg}},t=__decorate([wepy_redux_1.connect({fromPublish:function(e){return e.zone.from_publish},classHasChanged:function(e){return e.zone.classChanged}})],t)}(wepy_1.default.page);Page(require("./../npm/wepy/lib/wepy.js").default.$createPage(Zone,"pages/zone"));