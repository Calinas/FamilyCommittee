"use strict";function _interopRequireWildcard(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t}function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function e(e,t){for(var s=0;s<t.length;s++){var n=t[s];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,s,n){return s&&e(t.prototype,s),n&&e(t,n),t}}(),_dec,_class,_wepy=require("./../npm/wepy/lib/wepy.js"),_wepy2=_interopRequireDefault(_wepy),_wepyRedux=require("./../npm/wepy-redux/lib/index.js"),_user=require("./../api/user.js"),_common=require("./../utils/common.js"),_modal=require("./../components/modal.js"),_modal2=_interopRequireDefault(_modal),_searchResult=require("./../components/searchResult.js"),_searchResult2=_interopRequireDefault(_searchResult),_authorize=require("./../api/authorize.js"),authorizeReq=_interopRequireWildcard(_authorize),bindRelationship=(_dec=(0,_wepyRedux.connect)({isPresident:function(e){return e.zone.isPresident}}))(_class=function(e){function t(){var e,s,n,i;_classCallCheck(this,t);for(var o=arguments.length,r=Array(o),a=0;a<o;a++)r[a]=arguments[a];return s=n=_possibleConstructorReturn(this,(e=t.__proto__||Object.getPrototypeOf(t)).call.apply(e,[this].concat(r))),n.config={navigationBarTitleText:"家委会管理"},n.$repeat={},n.$props={Modal:{sureBtnText:"确认添加",cancelBtnText:"取消",placeholderText:"请输入姓名","xmlns:v-bind":"","v-bind:flag.sync":"showAdd","xmlns:v-on":""},Search:{"xmlns:v-on":"","xmlns:v-bind":"","v-bind:flag.sync":"showAdd","v-bind:studentList.sync":"studentList"}},n.$events={Modal:{"v-on:cancel":"cancel","v-on:sure":"sure"},Search:{"v-on:closeModal":"closeSearch","v-on:sure":"sure","v-on:selectStudent":"selectStudent"}},n.components={Modal:_modal2.default,Search:_searchResult2.default},n.data={showAdd:!1,list:[],currentRoleId:-1,memberInfo:null,classInfo:{},studentList:[],code:"",removeFlag:!1,removeName:"",removeId:-1,classId:-1,name:"",key:""},n.methods={remove:function(){var e=this;authorizeReq.removeMember({class_id:this.classInfo.id,remove_member_id:this.removeId}).then(function(t){t.data.success&&((0,_common.showMsg)("操作成功"),e.removeName="",e.removeId=-1,e.$apply())})},changeCode:function(){var e=this;authorizeReq.changeCode({class_id:this.classInfo.id,join_key:this.code}).then(function(t){t.data.success&&(e.classInfo.join_key=e.code,wx.setStorageSync("classInfo",e.classInfo),e.code="",e.$apply(),(0,_common.showMsg)("更新成功"))})},bindForm:function(e){this[e.currentTarget.id]=e.detail.value,this.$apply()},closeSearch:function(){this.showAdd=!1,this.$apply()},del:function(e){var t=this;authorizeReq.deleteAuth({class_id:this.classInfo.id,class_auth_id:e}).then(function(e){e.data.success&&((0,_common.showMsg)("删除成功"),t.getAuthList(),t.$apply())})},selectStudent:function(e){var t=this;this.removeFlag?(this.removeName=e.class_nickname,this.removeId=e.id,this.removeFlag=!1,this.showAdd=!1,this.$apply()):authorizeReq.addAuth({class_id:this.classInfo.id,role_id:this.currentRoleId,join_member_id:e.id}).then(function(e){e.data.success&&((0,_common.showMsg)("添加成功"),t.getAuthList(),t.showAdd=!1,t.$apply())})},cancel:function(){this.showAdd=!1,this.$apply()},addNew:function(e,t,s){this.showAdd=e,this.currentRoleId=t,"remove"===s&&(this.removeFlag=!0),this.$apply()},sure:function(e){var t=this;authorizeReq.searchMember({class_id:this.classInfo.id,keywords:e}).then(function(e){var s=e.data.list;s.length&&(t.studentList=s,t.$apply())})}},i=s,_possibleConstructorReturn(n,i)}return _inherits(t,e),_createClass(t,[{key:"onShareAppMessage",value:function(e){return{title:this.memberInfo.nickname+"邀请您加入家委会班级,验证码是"+this.classInfo.join_key,path:"pages/authorize?classId="+this.classInfo.id+"&name="+this.classInfo.name+"&key="+this.classInfo.join_key+"&code="+this.code}}},{key:"onLoad",value:function(e){this.classInfo=wx.getStorageSync("classInfo"),this.memberInfo=wx.getStorageSync("memberInfo"),this.name=e.name,this.code=e.code,this.key=e.key,this.classId=e.classId,this.code&&!this.memberInfo.member_id?wx.redirectTo({url:"login?classId="+this.classId+"&name="+this.name+"&key="+this.key}):this.code&&this.memberInfo.member_id?wx.redirectTo({url:"joinClass?classId="+this.classId+"&name="+this.name+"&key="+this.key}):(this.isPresident&&this.getAuthList(),this.getMemberList(),this.$apply())}},{key:"getMemberList",value:function(){var e=this;(0,_user.getMemberList)({class_id:this.classInfo.id}).then(function(t){for(var s=[],n=t.data.family_list.list,i=[],o=0,r=n.length;o<r;o++)for(var a=n[o].list,c=0,l=a.length;c<l;c++){var u=a[c].member;s.indexOf(u.id)<=0&&i.push(u),s.push(u.id)}e.studentList=i,e.$apply()})}},{key:"getAuthList",value:function(){var e=this;authorizeReq.authList({class_id:this.classInfo.id}).then(function(t){e.list=t.data.list,e.$apply()})}}]),t}(_wepy2.default.page))||_class;Page(require("./../npm/wepy/lib/wepy.js").default.$createPage(bindRelationship,"pages/authorize"));