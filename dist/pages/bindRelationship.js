"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var a=t[i];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,i,a){return i&&e(t.prototype,i),a&&e(t,a),t}}(),_dec,_class,_wepy=require("./../npm/wepy/lib/wepy.js"),_wepy2=_interopRequireDefault(_wepy),_wepyRedux=require("./../npm/wepy-redux/lib/index.js"),_actions=require("./../store/actions/index.js"),_user=require("./../api/user.js"),_createClass2=require("./../api/createClass.js"),_common=require("./../utils/common.js"),store=(0,_wepyRedux.getStore)(),bindRelationship=(_dec=(0,_wepyRedux.connect)({relationship:function(e){return e.zone.relationship}}))(_class=function(e){function t(){var e,i,a,n;_classCallCheck(this,t);for(var s=arguments.length,r=Array(s),c=0;c<s;c++)r[c]=arguments[c];return i=a=_possibleConstructorReturn(this,(e=t.__proto__||Object.getPrototypeOf(t)).call.apply(e,[this].concat(r))),a.config={navigationBarTitleText:"身份绑定"},a.data={parentIndex:0,canSubmit:!1,studentName:"",teacherName:"",list:[],memberInfo:null,classInfo:null,classId:-1,joinClassId:0,classIdentityList:[],type:"create",key:"",currentType:"parents",relationshipTypes:[{checked:!0,label:"我是家长",value:"parents"},{checked:!1,label:"我是教师",value:"teacher"}]},a.watch={relationship:function(e,t){t.length||!e.length||"create"!==this.type&&"join"!==this.type||this.addNewFn()},studentName:function(e,t){this.canSubmit=!(0,_common.isEmptyString)(e)}},a.methods={pickerChange:function(e){this[e.currentTarget.id]=e.detail.value,this.$apply()},delete:function(e){this.list.splice(e,1),this.$apply()},addNew:function(){this.addNewFn()},bindForm:function(e){var t=e.currentTarget,i=t.dataset.idx;this.list[i][t.id]=e.detail.value,this.$apply()},submit:function(){if("parents"===this.currentType&&!this.checkData())return void(0,_common.showMsg)("请填写您孩子姓名");this.checkCanSubmit();var e=this.list.map(function(e){return{identity_id:e.relationship[e.activeIndex].id,student_name:e.value}});if("edit"===this.type&&"parents"===this.currentType)e=this.list.map(function(e){return{identity_id:e.relationship[e.activeIndex].id,student_name:e.value,member_identity_id:e.id}}),this.joinClassCallback(this.classInfo.id,e);else if("edit"===this.type&&"teacher"===this.currentType)this.teacherCallback();else if("create"===this.type){var t=this.$parent.globalData.createClass,i={school_id:t.school_id,grade_type:t.grade,year_class:t.year,class:t.class};if("teacher"===this.currentType){var a={type:"teacher",list:[{name:this.teacherName}]};this.addClassCallback(i,a)}else{var n={type:"partiarch",list:e};this.addClassCallback(i,n)}}else"join"===this.type&&"parents"===this.currentType&&this.joinClassCallback(this.joinClassId,e)}},n=i,_possibleConstructorReturn(a,n)}return _inherits(t,e),_createClass(t,[{key:"onShow",value:function(){!this.relationship.length||"create"!==this.type&&"join"!==this.type||this.addNewFn()}},{key:"onLoad",value:function(e){!this.relationship.length&&(0,_actions.saveIdentityList)(),this.memberInfo=wx.getStorageSync("memberInfo"),this.classInfo=wx.getStorageSync("classInfo"),this.joinClassId=Number(e.id),this.key=e.key,this.type=e.type,"edit"===this.type&&this.getClassIdentity(),this.$apply()}},{key:"addClassCallback",value:function(e,t){var i=this;(0,_createClass2.addClass)(Object.assign({},e,{item:t})).then(function(e){i.commonFn(e)})}},{key:"joinClassCallback",value:function(e,t){(0,_user.bindIdentity)({class_id:e,item:t}).then(function(e){e.data.success&&((0,_common.showMsg)("成功绑定身份"),setTimeout(function(){wx.switchTab({url:"zone"})},2e3))})}},{key:"teacherCallback",value:function(){(0,_user.bindTeacher)({class_id:this.classInfo.id,name:this.teacherName}).then(function(e){e.data.success&&wx.switchTab({url:"zone"})})}},{key:"commonFn",value:function(e){if(e.data.success){(0,_common.showMsg)("班级创建成功");var t=e.data.data;wx.setStorage({key:"classInfo",data:t});var i="createClassSuccess?name="+t.name+"&code="+t.qr_code+"&key="+t.join_key+"&classId="+t.id;this.$parent.globalData.classHasChange=!0,setTimeout(function(){wx.navigateTo({url:i})},1e3)}}},{key:"getClassIdentity",value:function(){var e=this;(0,_user.identityList)({class_id:this.classInfo.id}).then(function(t){var i=t.data.list,a=i.filter(function(e){return"teacher"===e.app_type}),n=i.filter(function(e){return"student"===e.app_type});e.list=n.map(function(t){return{relationship:e.relationship,value:t.student.name,activeIndex:t.identity.id-1,id:t.id}}),e.teacherObj&&e.teacherObj.length&&(e.teacherName=a[0].teacher.name),e.$apply()})}},{key:"addNewFn",value:function(){var e={relationship:this.relationship,value:"",activeIndex:0};this.list.push(e),this.$apply()}},{key:"checkCanSubmit",value:function(){return"teacher"!==this.currentType||!(0,_common.isEmptyString)(this.teacherName)||((0,_common.showMsg)("如果您勾选了老师身份，请填写您的姓名"),!1)}},{key:"checkData",value:function(){for(var e=!0,t=0,i=this.list.length;t<i;t++){if((0,_common.isEmptyString)(this.list[t].value)){e=!1;break}e=!0}return e}}]),t}(_wepy2.default.page))||_class;Page(require("./../npm/wepy/lib/wepy.js").default.$createPage(bindRelationship,"pages/bindRelationship"));